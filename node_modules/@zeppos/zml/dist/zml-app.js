let e=null;e="undefined"!=typeof __$$R$$__?__$$R$$__:()=>{};let t=null;n()?t=hmApp.getPackageInfo:i()&&(t=e("@zos/app").getPackageInfo),n()?hmUI:i()&&e("@zos/ui"),n()?hmSetting.getDeviceInfo:i()&&e("@zos/device").getDeviceInfo,n()?"undefined"!=typeof __$$app$$__&&__$$app$$__:i()&&e("@zos/i18n").getText,n()?hmApp.gotoPage:i()&&e("@zos/router").push;let s=null;function n(){return o()&&r()}function i(){return o()&&a()}function r(){return"undefined"!=typeof hmApp}function a(){return"undefined"!=typeof __$$R$$__}function o(){return r()||a()}function h(e){return e?.constructor===Object}n()?s=hmBle:i()&&(s=e("@zos/ble"));let d=null;n()?d=DeviceRuntimeCore.HmLogger:i()?d=e("@zos/utils").log:"undefined"!=typeof messaging&&"undefined"!=typeof Logger&&(d=Logger);const p=e("@zos/utils").EventBus,u=e("@zos/timer").setTimeout,c=e("@zos/timer").clearTimeout;function l(){const e={canceled:!1};return e.promise=new Promise((function(t,s){e.resolve=t,e.reject=s})),e.cancel=()=>{e.canceled=!0,e.reject(new Error("Task canceled"))},e}function f(e,t){const s=l(),n=u((()=>{c(n),t?t&&t(s.resolve,s.reject):s.reject("Timed out in "+e+"ms.")}),e=e||1e3);return s.promise}function y(e){return I(function(e){return JSON.stringify(e)}(e))}function g(e){return t=T(e),JSON.parse(t);var t}function I(e){return Buffer.from(e,"utf-8")}function T(e){return e.toString("utf-8")}function m(e){return e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)}function b(e){return t=function(e){return Buffer.from(e)}(e),t.toString("hex");var t}const B=o()?d.getLogger("device-message"):d.getLogger("side-message"),k=void 0,L="json",S="text",w="bin",E={EMPTY:0,TEXT:1,JSON:2,BIN:3};function v(e){switch(e.toLowerCase()){case L:return E.JSON;case S:return E.TEXT;case w:return E.BIN;case"empty":return E.EMPTY;default:return E.BIN}}let U=1e4;function q(){return U++}let P=1e3;function C(){return P++}class x extends p{constructor(e,t,s){super(),this.id=e,this.type=t,this.ctx=s,this.tempBuf=null,this.chunks=[],this.count=0,this.finishChunk=null}addChunk(e){1===e.opCode&&(this.count=e.seqId,this.finishChunk=e),e.payloadLength===e.payload.byteLength?(this.chunks.push(e),this.checkIfReceiveAllChunks()):this.emit("error",Error(`receive chunk data length error, expect ${e.payloadLength} but ${e.payload.byteLength}`))}checkIfReceiveAllChunks(){if(this.count===this.chunks.length){for(let e=1;e<=this.count;e++){const t=this.chunks.find((t=>t.seqId===e));if(!t)return this.releaseBuf(),void this.emit("error",Error("receive data error"));const s=t.payload;this.tempBuf=this.tempBuf?Buffer.concat([this.tempBuf,s]):s}this.finishChunk&&(this.finishChunk.payload=this.tempBuf,this.finishChunk.payloadLength=this.finishChunk.payload.byteLength,this.finishChunk.totalLength===this.finishChunk.payloadLength?this.emit("data",this.finishChunk):this.emit("error",Error(`receive full data length error, expect ${this.finishChunk.payloadLength} but ${this.finishChunk.payload.byteLength}`)))}}getLength(){return this.tempBufLength}releaseBuf(){this.tempBuf=null,this.chunks=[],this.finishChunk=null,this.count=0}}class D{constructor(){this.sessions=new Map}key(e){return`${e.id}:${e.type}`}newSession(e,t,s){const n=new x(e,t,s);return this.sessions.set(this.key(n),n),n}destroy(e){e.releaseBuf(),this.sessions.delete(this.key(e))}has(e,t){return this.sessions.has(this.key({id:e,type:t}))}getById(e,t){return this.sessions.get(this.key({id:e,type:t}))}clear(){this.sessions.clear()}}class O extends Error{constructor(e,t){super(t),this.code=e}}class N extends p{constructor({appId:e=0,appDevicePort:t=20,appSidePort:n=0,ble:i=(o()?s:void 0)}={appId:0,appDevicePort:20,appSidePort:0,ble:o()?s:void 0}){super(),this.isDevice=o(),this.isSide=!this.isDevice,this.appId=e,this.appDevicePort=t,this.appSidePort=n,this.ble=i,this.sendMsg=this.getSafeSend(),this.chunkSize=3584,this.tempBuf=null,this.handlers=new Map,this.shakeTask=null,this.waitingShakePromise=null,this.shakeStatus=1,this.shakeTimer=0,this.sessionMgr=new D,this.on("response",(e=>{this.onResponse(e)}))}fork(e=5e3){return 2===this.shakeStatus||(this.shakeTask=l(),this.waitingShakePromise=this.shakeTask.promise,this.shakeStatus=1,this.clearShakeTimer(),this.shakeTimer=u((()=>{this.shakeStatus=4,this.shakeTask.reject(new O(1,"shake timeout"))}),e),this.shakeStatus=2,this.sendShake()),this.waitingShakePromise}clearShakeTimer(){this.shakeTimer&&c(this.shakeTimer),this.shakeTimer=0}getMessageSize(){return 3600}getMessagePayloadSize(){return 3584}getMessageHeaderSize(){return 16}buf2Json(e){return g(e)}json2Buf(e){return y(e)}now(e=Date.now()){return function(e=Date.now()){return e%1e7}(e)}connect(e){this.on("message",(e=>{this.onMessage(e)})),this.ble&&this.ble.createConnect(((e,t,s)=>{this.onFragmentData(t)})),e&&e(this)}disConnect(e){this.sendClose(),this.off("message"),this.handlers.clear(),this.ble&&this.ble.disConnect(),e&&e(this)}listen(e){this.appSidePort=globalThis.getApp().port2,messaging&&messaging.peerSocket.addListener("message",(e=>{this.onMessage(e)})),this.waitingShakePromise=Promise.resolve(),e&&e(this)}buildBin(e){if(e.payload.byteLength>this.chunkSize)throw new Error(`${e.payload.byteLength} greater than max size of ${this.chunkSize}`);const t=this.getMessageHeaderSize()+e.payload.byteLength;let s=Buffer.alloc(t),n=0;return s.writeUInt8(e.flag,n),n+=1,s.writeUInt8(e.version,n),n+=1,s.writeUInt16LE(e.type,n),n+=2,s.writeUInt16LE(e.port1,n),n+=2,s.writeUInt16LE(e.port2,n),n+=2,s.writeUInt32LE(e.appId,n),n+=4,s.writeUInt32LE(e.extra,n),n+=4,s.fill(e.payload,n,e.payload.byteLength+n),s}buildShake(){return this.buildBin({flag:1,version:1,type:1,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,payload:Buffer.from([this.appId])})}sendShake(){const e=this.buildShake();this.sendMsg(e)}buildClose(){return this.buildBin({flag:1,version:1,type:2,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,payload:Buffer.from([this.appId])})}sendClose(){const e=this.buildClose();this.sendMsg(e)}readBin(e){const t=Buffer.from(e);let s=0;const n=t.readUInt8(s);s+=1;const i=t.readUInt8(s);s+=1;const r=t.readUInt16LE(s);s+=2;const a=t.readUInt16LE(s);s+=2;const o=t.readUInt16LE(s);s+=2;const h=t.readUInt32LE(s);s+=4;const d=t.readUInt32LE(s);return s+=4,{flag:n,version:i,type:r,port1:a,port2:o,appId:h,extra:d,payload:t.subarray(s)}}buildData(e,t={}){return this.buildBin({flag:1,version:1,type:4,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,...t,payload:e})}sendBin(e,t=k){if(t&&B.warn("[RAW] [S] send size=%d bin=%s",e.byteLength,b(e.buffer)),!this.ble.send(e.buffer,e.byteLength))throw Error("send message error")}sendBinBySide(e,t=k){t&&B.warn("[RAW] [S] send size=%d bin=%s",e.byteLength,b(e.buffer)),messaging.peerSocket.send(e.buffer)}getSafeSend(){return this.isDevice?this.sendBin.bind(this):this.sendBinBySide.bind(this)}sendHmProtocol({requestId:e,dataBin:t,type:s,contentType:n,dataType:i},{messageType:r=4}={}){const a=3518,o=t.byteLength;let h=0;const d=Buffer.alloc(a),p=e||q(),u=C();let c=1;const l=Math.ceil(o/a);function f(){return c++}for(let e=1;e<=l;e++){if(this.errorIfBleDisconnect(),e===l){const e=o-h,a=Buffer.alloc(0+e);t.copy(a,0,h,h+e),h+=e,this.sendDataWithSession({traceId:p,spanId:u,seqId:f(),payload:a,type:s,opCode:1,totalLength:o,contentType:n,dataType:i},{messageType:r});break}t.copy(d,0,h,h+a),h+=a,this.sendDataWithSession({traceId:p,spanId:u,seqId:f(),payload:d,type:s,opCode:0,totalLength:o,contentType:n,dataType:i},{messageType:r})}}sendJson({requestId:e=0,json:t,type:s=1,contentType:n,dataType:i}){const r=y(t),a=e||q();this.sendHmProtocol({requestId:a,dataBin:r,type:s,contentType:n,dataType:i})}sendBuf({requestId:e=0,buf:t,type:s=1,contentType:n,dataType:i}){const r=e||q();return this.sendHmProtocol({requestId:r,dataBin:t,type:s,contentType:n,dataType:i})}sendText({requestId:e=0,text:t,type:s=1,contentType:n,dataType:i}){const r=I(t),a=e||q();return this.sendHmProtocol({requestId:a,dataBin:r,type:s,contentType:n,dataType:i})}sendDataWithSession({traceId:e,spanId:t,seqId:s,payload:n,type:i,opCode:r,totalLength:a,contentType:o,dataType:h},{messageType:d}){const p=this.buildPayload({traceId:e,spanId:t,seqId:s,totalLength:a,type:i,opCode:r,payload:n,contentType:o,dataType:h});let u=this.isDevice?this.buildData(p,{type:d}):p;this.sendMsg(u)}buildPayload(e){const t=66+e.payload.byteLength;let s=Buffer.alloc(t),n=0;return s.writeUInt32LE(e.traceId,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(e.spanId,n),n+=4,s.writeUInt32LE(e.seqId,n),n+=4,s.writeUInt32LE(e.totalLength,n),n+=4,s.writeUInt32LE(e.payload.byteLength,n),n+=4,s.writeUInt8(e.type,n),n+=1,s.writeUInt8(e.opCode,n),n+=1,s.writeUInt32LE(this.now(),n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt8(e.contentType,n),n+=1,s.writeUInt8(e.dataType,n),n+=1,s.writeUInt16LE(0,n),n+=2,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.fill(e.payload,n,e.payload.byteLength+n),s}readPayload(e){const t=Buffer.from(e);let s=0;const n=t.readUInt32LE(s);s+=4;const i=t.readUInt32LE(s);s+=4;const r=t.readUInt32LE(s);s+=4;const a=t.readUInt32LE(s);s+=4;const o=t.readUInt32LE(s);s+=4;const h=t.readUInt32LE(s);s+=4;const d=t.readUInt8(s);s+=1;const p=t.readUInt8(s);s+=1;const u=t.readUInt32LE(s);s+=4;const c=t.readUInt32LE(s);s+=4;const l=t.readUInt32LE(s);s+=4;const f=t.readUInt32LE(s);s+=4;const y=t.readUInt32LE(s);s+=4;const g=t.readUInt32LE(s);s+=4;const I=t.readUInt32LE(s);s+=4;const T=t.readUInt8(s);s+=1;const m=t.readUInt8(s);s+=1;const b=t.readUInt16LE(s);s+=2;const B=t.readUInt32LE(s);s+=4;const k=t.readUInt32LE(s);return s+=4,{traceId:n,parentId:i,spanId:r,seqId:a,totalLength:o,payloadLength:h,payloadType:d,opCode:p,contentType:T,dataType:m,timestamp1:u,timestamp2:c,timestamp3:l,timestamp4:f,timestamp5:y,timestamp6:g,timestamp7:I,extra1:b,extra2:B,extra3:k,payload:t.subarray(s)}}onFragmentData(e){const t=this.readBin(e);this.emit("raw",e),1===t.flag&&1===t.type?(this.appSidePort=t.port2,this.emit("shake:response",t),this.clearShakeTimer(),this.shakeTask.resolve(),this.shakeStatus=3):1===t.flag&&4===t.type||1===t.flag&&5===t.type?(this.emit("message",t.payload),this.emit("read",t)):1===t.flag&&6===t.type?this.emit("log",t.payload):0===t.flag||1===t.flag&&2===t.type&&(this.appSidePort=0)}errorIfBleDisconnect(){if(o()&&!this.ble.connectStatus())throw new O(2,"ble disconnect")}errorIfSideServiceDisconnect(){if(o&&!this.appSidePort)throw new O(3,"side service is not running")}getRequestCount(){return this.handlers.size}onResponse(e){const t=this.handlers.get(e.traceId);t&&t(e)}onMessage(e){const t=this.readPayload(e);let s=this.sessionMgr.getById(t.traceId,t.payloadType);s||(s=this.sessionMgr.newSession(t.traceId,t.payloadType,this),s.on("data",(e=>{1===e.opCode&&(1===e.payloadType?this.emit("request",{request:e,response:({data:t,dataType:s})=>{s=void 0!==s?v(s):e.dataType,this.response({requestId:e.traceId,contentType:e.contentType,dataType:s,data:t})}}):2===e.payloadType?this.emit("response",e):3===e.payloadType&&this.emit("call",e),this.emit("data",e),this.sessionMgr.destroy(s))})),s.on("error",(e=>{this.sessionMgr.destroy(s),this.emit("error",e)}))),s.addChunk(t)}request(e,t){try{this.errorIfBleDisconnect()}catch(e){return Promise.reject(e)}return this.waitingShakePromise.then((()=>{this.errorIfBleDisconnect(),this.errorIfSideServiceDisconnect();let s=w;"string"==typeof e?s=S:h(e)?s=L:(e instanceof ArrayBuffer||ArrayBuffer.isView(e)||Buffer.isBuffer(e))&&(s=w);const n={timeout:6e4,contentType:s,dataType:s},i=q(),r=l();t=Object.assign(n,t),this.handlers.set(i,(({traceId:e,payload:t,dataType:s})=>{let n;switch(this.errorIfBleDisconnect(),this.errorIfSideServiceDisconnect(),s){case E.TEXT:n=T(t);break;case E.BIN:n=t;break;case E.JSON:n=g(t);break;default:n=t}r.resolve(n)})),Buffer.isBuffer(e)?this.sendBuf({requestId:i,buf:e,type:1,contentType:E.BIN,dataType:v(t.dataType)}):e instanceof ArrayBuffer||ArrayBuffer.isView(e)?this.sendBuf({requestId:i,buf:Buffer.from(e),type:1,contentType:E.BIN,dataType:v(t.dataType)}):v(t.contentType)===E.JSON?this.sendJson({requestId:i,json:e,type:1,contentType:E.JSON,dataType:v(t.dataType)}):v(t.contentType)===E.TEXT?this.sendText({requestId:i,text:e,type:1,contentType:E.TEXT,dataType:v(t.dataType)}):this.sendBuf({requestId:i,buf:Buffer.from(e),type:1,contentType:E.BIN,dataType:v(t.dataType)});let a=!1;return Promise.race([f(t.timeout,((e,s)=>{if(a)return e();s(new O(4,`request timed out in ${t.timeout}ms.`))})),r.promise.finally((()=>{a=!0}))]).catch((e=>{throw e})).finally((()=>{this.handlers.delete(i)}))}))}response({requestId:e,contentType:t,dataType:s,data:n}){E.BIN===s?this.sendBuf({requestId:e,buf:n,type:2,contentType:t,dataType:s}):E.TEXT===s?this.sendText({requestId:e,text:n,type:2,contentType:t,dataType:s}):E.JSON===s?this.sendJson({requestId:e,json:n,type:2,contentType:t,dataType:s}):this.sendBuf({requestId:e,buf:n,type:2,contentType:t,dataType:E.BIN})}call(e){let t=E.JSON;return"string"==typeof e?t=E.TEXT:h(e)?t=E.JSON:(e instanceof ArrayBuffer||ArrayBuffer.isView(e)||Buffer.isBuffer(e))&&(t=E.BIN),this.waitingShakePromise.then((()=>Buffer.isBuffer(e)?this.sendBuf({buf:e,type:3,contentType:E.BIN,dataType:E.EMPTY}):e instanceof ArrayBuffer||ArrayBuffer.isView(e)?this.sendBuf({buf:Buffer.from(e),type:3,contentType:E.BIN,dataType:E.EMPTY}):t===E.JSON?this.sendJson({json:e,type:3,contentType:E.JSON,dataType:E.EMPTY}):t===E.TEXT?this.sendText({text:e,type:3,contentType:E.TEXT,dataType:E.EMPTY}):this.sendBuf({buf:Buffer.from(e),type:3,contentType:E.BIN,dataType:E.EMPTY})))}}d.getLogger("message-builder");const $=5e3,j=6e4,M="hmrpcv1",R=20,z=0;function J(){return e=new N({appId:t().appId,appDevicePort:R,appSidePort:z}),{shakeTimeout:$,requestTimeout:j,onCall(t){return t?(e.on("call",(({contentType:e,payload:s})=>{switch(e){case E.JSON:s=g(s);break;case E.TEXT:s=T(s);break;case E.BIN:default:s=m(s)}t&&t(s)})),this):this},offOnCall(t){return e.off("call",t),this},call(t){return o()&&e.fork(this.shakeTimeout),t=h(t)?opts.contentType?t:{jsonrpc:M,...t}:t,e.call(t)},onRequest(t){return t?(e.on("request",(e=>{let s=e.request.payload;switch(e.request.contentType){case E.JSON:s=g(s);break;case E.TEXT:s=T(s);break;case E.BIN:default:s=m(s)}t&&t(s,((t,n,i={})=>e.request.contentType===E.JSON&&s?.jsonrpc===M?t?e.response({data:{jsonrpc:M,error:t}}):e.response({data:{jsonrpc:M,result:n}}):e.response({data:n,...i})))})),this):this},cancelAllRequest(){return e.off("response"),this},offOnRequest(t){return e.off("request",t),this},request(t,s={}){return o()&&e.fork(this.shakeTimeout),t=h(t)?s.contentType?t:{jsonrpc:M,...t}:t,e.request(t,{timeout:this.requestTimeout,...s}).then((e=>{if(!h(e)||e.jsonrpc!==M)return e;const{error:t,result:s}=e;if(t)throw t;return s}))},connect(){return e.connect((()=>{})),this},disConnect(){return this.cancelAllRequest(),this.offOnRequest(),this.offOnCall(),e.disConnect((()=>{})),this},start(){return e.listen((()=>{})),this},stop(){return this.cancelAllRequest(),this.offOnRequest(),this.offOnCall(),e.disConnect((()=>{})),this}};var e}const _=e("@zos/ble/TransferFile"),A=(F=new _,{onFile(e){return e?(void 0===F||F.inbox.on("newfile",(function(){const t=F.inbox.getNextFile();e&&e(t)})),this):this},onSideServiceFileFinished(e){return e?(void 0===F||F.inbox.on("file",(function(){const t=F.inbox.getNextFile();e&&e(t)})),this):this},emitFile(){return F.inbox.emit("file"),this},offFile(){return void 0===F||(F.inbox.off("newfile"),F.inbox.off("file")),this},getFile:()=>void 0===F?null:F.inbox.getNextFile(),sendFile(e,t){if(void 0===F)throw new Error("fileTransfer is not available");return F.outbox.enqueueFile(e,t)}});var F;const X=Object.prototype.hasOwnProperty;function H(e,t){return Object.getOwnPropertyNames(t).forEach((function(s){if(!X.call(e,s)){var n=Object.getOwnPropertyDescriptor(t,s);Object.defineProperty(e,s,n)}})),e}function Y({globalData:e={},onCreate:t,onDestroy:s,...n}={}){const i={globalData:e,...n,onCreate(...e){this.messaging=this.globalData.messaging=J(),this.messaging.onCall(this.onCall?.bind(this)).onRequest(this.onRequest?.bind(this)).connect(),A.onFile(this.onReceivedFile?.bind(this));for(let t=0;t<=Y.mixins.length-1;t++){const s=Y.mixins[t];s.handler.onCreate?.apply(this,e)}t?.apply(this,e)},onDestroy(...e){s?.apply(this,e);for(let t=Y.mixins.length-1;t>=0;t--){const s=Y.mixins[t];s.handler.onDestroy?.apply(this,e)}this.messaging.offOnCall().offOnRequest().disConnect(),A.offFile()}};return Y.handle(i),i}H(Y,{init(){this.plugins=[],this.settings={},this.mixins=[]},set(e,t){if(1===arguments.length)return this.settings[e];this.settings[e]=t},use(e,...t){return"function"==typeof e?this.plugins.push({handler:e,args:t}):"object"==typeof e&&this.mixins.push({handler:e,args:[]}),this},handle(e){this.plugins.forEach((t=>{t&&"function"==typeof t.handler&&t.handler.call(this,e,...t.args)})),this.mixins.forEach((({handler:{onInit:t,onPause:s,build:n,onResume:i,onDestroy:r,onCreate:a,...o},args:h})=>{Object.assign(e,o)}))}}),Y.init(),Y.use((function(e){e.httpRequest=function(e,t={}){return this.messaging.request({method:"http.request",params:e},t)}}));export{Y as BaseApp,H as merge};
